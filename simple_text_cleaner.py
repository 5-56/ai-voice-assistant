#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
ç®€åŒ–çš„æ–‡æœ¬æ¸…ç†æ¨¡å—
ä¸“é—¨ç”¨äºæ¸…ç†TTSæœ—è¯»æ–‡æœ¬ä¸­çš„è¡¨æƒ…ç¬¦å·å’Œç‰¹æ®Šç¬¦å·
"""

import re
import logging

def clean_text_for_tts(text: str) -> str:
    """æ¸…ç†æ–‡æœ¬ç”¨äºTTSæœ—è¯»"""
    if not text or not text.strip():
        return ""
    
    try:
        original_text = text
        
        # 1. ç§»é™¤å¸¸è§è¡¨æƒ…ç¬¦å·ï¼ˆç›´æ¥å­—ç¬¦æ›¿æ¢ï¼‰
        emoji_chars = [
            'ğŸ˜€', 'ğŸ˜', 'ğŸ˜‚', 'ğŸ¤£', 'ğŸ˜ƒ', 'ğŸ˜„', 'ğŸ˜…', 'ğŸ˜†', 'ğŸ˜‰', 'ğŸ˜Š', 'ğŸ˜‹', 'ğŸ˜', 'ğŸ˜', 'ğŸ˜˜', 'ğŸ¥°', 'ğŸ˜—', 'ğŸ˜™', 'ğŸ˜š', 'â˜ºï¸', 'ğŸ™‚', 'ğŸ¤—', 'ğŸ¤©', 'ğŸ¤”', 'ğŸ¤¨', 'ğŸ˜', 'ğŸ˜‘', 'ğŸ˜¶', 'ğŸ™„', 'ğŸ˜', 'ğŸ˜£', 'ğŸ˜¥', 'ğŸ˜®', 'ğŸ¤', 'ğŸ˜¯', 'ğŸ˜ª', 'ğŸ˜«', 'ğŸ˜´', 'ğŸ˜Œ', 'ğŸ˜›', 'ğŸ˜œ', 'ğŸ˜', 'ğŸ¤¤', 'ğŸ˜’', 'ğŸ˜“', 'ğŸ˜”', 'ğŸ˜•', 'ğŸ™ƒ', 'ğŸ¤‘', 'ğŸ˜²', 'â˜¹ï¸', 'ğŸ™', 'ğŸ˜–', 'ğŸ˜', 'ğŸ˜Ÿ', 'ğŸ˜¤', 'ğŸ˜¢', 'ğŸ˜­', 'ğŸ˜¦', 'ğŸ˜§', 'ğŸ˜¨', 'ğŸ˜©', 'ğŸ¤¯', 'ğŸ˜¬', 'ğŸ˜°', 'ğŸ˜±', 'ğŸ¥µ', 'ğŸ¥¶', 'ğŸ˜³', 'ğŸ¤ª', 'ğŸ˜µ', 'ğŸ˜¡', 'ğŸ˜ ', 'ğŸ¤¬', 'ğŸ˜·', 'ğŸ¤’', 'ğŸ¤•', 'ğŸ¤¢', 'ğŸ¤®', 'ğŸ¤§', 'ğŸ˜‡', 'ğŸ¥³', 'ğŸ¥º', 'ğŸ¤ ', 'ğŸ¤¡', 'ğŸ¤¥', 'ğŸ¤«', 'ğŸ¤­', 'ğŸ§',
            'ğŸ‘', 'ğŸ‘', 'ğŸ‘Œ', 'âœŒï¸', 'ğŸ¤', 'ğŸ¤Ÿ', 'ğŸ¤˜', 'ğŸ¤™', 'ğŸ‘ˆ', 'ğŸ‘‰', 'ğŸ‘†', 'ğŸ‘‡', 'â˜ï¸', 'âœ‹', 'ğŸ¤š', 'ğŸ–', 'ğŸ––', 'ğŸ‘‹', 'ğŸ¤', 'ğŸ’ª', 'ğŸ¦¾', 'ğŸ–•', 'âœï¸', 'ğŸ™',
            'ğŸ‰', 'ğŸ’°', 'â¤ï¸', 'ğŸ’¯', 'ğŸ”¥', 'ğŸ’•', 'ğŸ’–', 'ğŸ’—', 'ğŸ’˜', 'ğŸ’', 'ğŸ’', 'ğŸ’Ÿ', 'ğŸ’¢', 'ğŸ’¤', 'ğŸ’¥', 'ğŸ’¦', 'ğŸ’¨', 'ğŸ’«', 'ğŸ’¬', 'ğŸ’­', 'ğŸ—¯', 'ğŸ’®'
        ]
        
        for char in emoji_chars:
            text = text.replace(char, '')
        
        # 2. ç§»é™¤è£…é¥°æ€§ç¬¦å·
        decorative_chars = [
            'ğŸŒŸ', 'ğŸŒ¸', 'âœ¨', 'â­', 'ğŸ’«', 'âš¡', 'ğŸŒˆ', 'ğŸˆ', 'ğŸŠ', 'ğŸ', 'ğŸ€', 'ğŸŒº', 'ğŸŒ»', 'ğŸŒ·', 'ğŸŒ¹', 'ğŸŒ¼', 'ğŸŒ™', 'â˜€ï¸', 'â›…', 'ğŸŒ ', 'ğŸŒŒ'
        ]
        
        for char in decorative_chars:
            text = text.replace(char, '')
        
        # 3. ç§»é™¤ç‰¹æ®Šç¬¦å·
        special_chars = [
            'ï½', 'ã€œ', 'âˆ¼', 'â‰ˆ', 'â‰‹', 'â‰…', 'â‰ƒ', 'â‰‚', 'â‰¡', 'â‰¢', 'â‰£', 'â‰¤', 'â‰¥',
            'â˜…', 'â˜†', 'âœ¦', 'âœ§', 'âœ©', 'âœª', 'âœ«', 'âœ¬', 'âœ­', 'âœ®', 'âœ¯', 'âœ°', 'âœ±', 'âœ²', 'âœ³', 'âœ´', 'âœµ', 'âœ¶', 'âœ·', 'âœ¸', 'âœ¹', 'âœº', 'âœ»', 'âœ¼', 'âœ½', 'âœ¾', 'âœ¿',
            'â†', 'â†‘', 'â†’', 'â†“', 'â†”', 'â†•', 'â†–', 'â†—', 'â†˜', 'â†™'
        ]
        
        for char in special_chars:
            text = text.replace(char, '')
        
        # 4. å¤„ç†è´§å¸å’Œæ•°å­¦ç¬¦å·ï¼ˆæ›¿æ¢ä¸ºæ–‡å­—ï¼‰
        replacements = {
            '$': 'ç¾å…ƒ',
            'â‚¬': 'æ¬§å…ƒ', 
            'Â£': 'è‹±é•‘',
            'Â¥': 'äººæ°‘å¸',
            'Â±': 'æ­£è´Ÿ',
            'Ã—': 'ä¹˜ä»¥',
            'Ã·': 'é™¤ä»¥',
            'â‰ ': 'ä¸ç­‰äº',
            'âˆ': 'æ— ç©·å¤§',
            'âˆš': 'æ ¹å·',
            'Â²': 'å¹³æ–¹',
            'Â³': 'ç«‹æ–¹',
            '%': 'ç™¾åˆ†ä¹‹',
            'â€°': 'åƒåˆ†ä¹‹'
        }
        
        for symbol, replacement in replacements.items():
            text = text.replace(symbol, replacement)
        
        # 5. ç§»é™¤ä»£ç å—
        text = re.sub(r'```[\s\S]*?```', '', text, flags=re.DOTALL)
        text = re.sub(r'`[^`\n]+`', '', text)
        
        # 6. å¤„ç†Markdowné“¾æ¥ï¼Œä¿ç•™é“¾æ¥æ–‡æœ¬
        text = re.sub(r'\[([^\]]+)\]\([^\)]+\)', r'\1', text)
        
        # 7. ç§»é™¤ç½‘å€
        text = re.sub(r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+', '', text)
        
        # 8. ç§»é™¤é‚®ç®±
        text = re.sub(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b', '', text)
        
        # 9. æ¸…ç†å¤šä½™çš„ç©ºæ ¼
        text = re.sub(r'\s+', ' ', text)
        text = text.strip()
        
        # 10. å¦‚æœæ¸…ç†åæ–‡æœ¬ä¸ºç©ºæˆ–è¿‡çŸ­ï¼Œè¿”å›åŸæ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯æ­£å¸¸æ–‡æœ¬ï¼‰
        if not text.strip() or len(text.strip()) < 3:
            # æ£€æŸ¥åŸæ–‡æœ¬æ˜¯å¦ä¸»è¦æ˜¯ä¸­æ–‡æˆ–è‹±æ–‡
            if re.search(r'[\u4e00-\u9fff\w]', original_text):
                return original_text.strip()
        
        return text
        
    except Exception as e:
        logging.error(f"æ–‡æœ¬æ¸…ç†å¤±è´¥: {e}")
        return original_text

def clean_text_for_display(text: str) -> str:
    """æ¸…ç†æ–‡æœ¬ç”¨äºæ˜¾ç¤ºï¼ˆä¿ç•™æ›´å¤šæ ¼å¼ï¼‰"""
    if not text:
        return ""
    
    try:
        # åªè¿›è¡ŒåŸºæœ¬æ¸…ç†ï¼Œä¿ç•™å¤§éƒ¨åˆ†æ ¼å¼
        # ç§»é™¤é›¶å®½å­—ç¬¦
        for char in ['\u200B', '\u200C', '\u200D', '\u2060', '\uFEFF']:
            text = text.replace(char, '')
        
        # æ ‡å‡†åŒ–ç©ºæ ¼
        text = re.sub(r'[\u00A0\u2000-\u200A]', ' ', text)
        
        # æ¸…ç†å¤šä½™çš„ç©ºæ ¼
        text = re.sub(r' +', ' ', text)
        text = text.strip()
        
        return text
        
    except Exception as e:
        logging.error(f"æ˜¾ç¤ºæ–‡æœ¬æ¸…ç†å¤±è´¥: {e}")
        return text

# æµ‹è¯•å‡½æ•°
def test_cleaner():
    """æµ‹è¯•æ–‡æœ¬æ¸…ç†åŠŸèƒ½"""
    test_cases = [
        "ä½ å¥½ğŸ˜€æˆ‘å¾ˆå¼€å¿ƒğŸ˜‚ä»Šå¤©å¤©æ°”ä¸é”™ğŸ‘",
        "ğŸŒŸ è¿™æ˜¯ä¸€ä¸ªæµ‹è¯• ğŸŒ¸âœ¨",
        "ï½ ğŸ˜‰ ç‰¹æ®Šç¬¦å·æµ‹è¯•",
        "è¿™æ˜¯æ­£å¸¸æ–‡æœ¬ï¼Œåº”è¯¥ä¿æŒä¸å˜ã€‚",
        "ä»·æ ¼æ˜¯$100ï¼Œçº¦åˆÂ¥700äººæ°‘å¸",
        "è®¡ç®—ç»“æœï¼š2Ã—3=6ï¼Œçº¦ç­‰äºâ‰ˆ6.0"
    ]
    
    print("ğŸ§¹ æ–‡æœ¬æ¸…ç†æµ‹è¯•:")
    for i, text in enumerate(test_cases, 1):
        cleaned = clean_text_for_tts(text)
        print(f"{i}. åŸæ–‡: {text}")
        print(f"   ç»“æœ: {cleaned}")
        print(f"   é•¿åº¦: {len(text)} -> {len(cleaned)}")
        print()

if __name__ == "__main__":
    test_cleaner()
