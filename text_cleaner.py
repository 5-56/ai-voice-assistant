#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ–‡æœ¬æ¸…ç†æ¨¡å—
ç”¨äºæ¸…ç†æ–‡æœ¬ä¸­çš„è¡¨æƒ…ç¬¦å·ã€ç‰¹æ®Šç¬¦å·ç­‰ä¸é€‚åˆæœ—è¯»çš„å†…å®¹
"""

import re
import logging

class TextCleaner:
    """æ–‡æœ¬æ¸…ç†å™¨"""
    
    def __init__(self):
        # è¡¨æƒ…ç¬¦å·æ­£åˆ™è¡¨è¾¾å¼ï¼ˆæ›´å…¨é¢çš„UnicodeèŒƒå›´ï¼‰
        self.emoji_pattern = re.compile(
            "["
            "\U0001F600-\U0001F64F"  # è¡¨æƒ…ç¬¦å·
            "\U0001F300-\U0001F5FF"  # ç¬¦å·å’Œè±¡å½¢æ–‡å­—
            "\U0001F680-\U0001F6FF"  # äº¤é€šå’Œåœ°å›¾ç¬¦å·
            "\U0001F1E0-\U0001F1FF"  # å›½æ——
            "\U00002702-\U000027B0"  # æ‚é¡¹ç¬¦å·
            "\U000024C2-\U0001F251"  # å…¶ä»–ç¬¦å·
            "\U0001F900-\U0001F9FF"  # è¡¥å……ç¬¦å·å’Œè±¡å½¢æ–‡å­—
            "\U0001FA70-\U0001FAFF"  # æ‰©å±•ç¬¦å·A
            "\U00002600-\U000026FF"  # æ‚é¡¹ç¬¦å·
            "\U00002700-\U000027BF"  # è£…é¥°ç¬¦å·
            "]+",
            flags=re.UNICODE
        )
        
        # ç‰¹æ®Šç¬¦å·å’Œæ ‡ç‚¹ç¬¦å·
        self.special_symbols = {
            # å¸¸è§è¡¨æƒ…ç¬¦å·æ–‡æœ¬
            'ğŸ˜€': '', 'ğŸ˜': '', 'ğŸ˜‚': '', 'ğŸ¤£': '', 'ğŸ˜ƒ': '', 'ğŸ˜„': '', 'ğŸ˜…': '', 'ğŸ˜†': '',
            'ğŸ˜‰': '', 'ğŸ˜Š': '', 'ğŸ˜‹': '', 'ğŸ˜': '', 'ğŸ˜': '', 'ğŸ˜˜': '', 'ğŸ¥°': '', 'ğŸ˜—': '',
            'ğŸ˜™': '', 'ğŸ˜š': '', 'â˜ºï¸': '', 'ğŸ™‚': '', 'ğŸ¤—': '', 'ğŸ¤©': '', 'ğŸ¤”': '', 'ğŸ¤¨': '',
            'ğŸ˜': '', 'ğŸ˜‘': '', 'ğŸ˜¶': '', 'ğŸ™„': '', 'ğŸ˜': '', 'ğŸ˜£': '', 'ğŸ˜¥': '', 'ğŸ˜®': '',
            'ğŸ¤': '', 'ğŸ˜¯': '', 'ğŸ˜ª': '', 'ğŸ˜«': '', 'ğŸ˜´': '', 'ğŸ˜Œ': '', 'ğŸ˜›': '', 'ğŸ˜œ': '',
            'ğŸ˜': '', 'ğŸ¤¤': '', 'ğŸ˜’': '', 'ğŸ˜“': '', 'ğŸ˜”': '', 'ğŸ˜•': '', 'ğŸ™ƒ': '', 'ğŸ¤‘': '',
            'ğŸ˜²': '', 'â˜¹ï¸': '', 'ğŸ™': '', 'ğŸ˜–': '', 'ğŸ˜': '', 'ğŸ˜Ÿ': '', 'ğŸ˜¤': '', 'ğŸ˜¢': '',
            'ğŸ˜­': '', 'ğŸ˜¦': '', 'ğŸ˜§': '', 'ğŸ˜¨': '', 'ğŸ˜©': '', 'ğŸ¤¯': '', 'ğŸ˜¬': '', 'ğŸ˜°': '',
            'ğŸ˜±': '', 'ğŸ¥µ': '', 'ğŸ¥¶': '', 'ğŸ˜³': '', 'ğŸ¤ª': '', 'ğŸ˜µ': '', 'ğŸ˜¡': '', 'ğŸ˜ ': '',
            'ğŸ¤¬': '', 'ğŸ˜·': '', 'ğŸ¤’': '', 'ğŸ¤•': '', 'ğŸ¤¢': '', 'ğŸ¤®': '', 'ğŸ¤§': '', 'ğŸ˜‡': '',
            'ğŸ¥³': '', 'ğŸ¥º': '', 'ğŸ¤ ': '', 'ğŸ¤¡': '', 'ğŸ¤¥': '', 'ğŸ¤«': '', 'ğŸ¤­': '', 'ğŸ§': '',
            
            # æ‰‹åŠ¿å’Œäººç‰©
            'ğŸ‘': '', 'ğŸ‘': '', 'ğŸ‘Œ': '', 'âœŒï¸': '', 'ğŸ¤': '', 'ğŸ¤Ÿ': '', 'ğŸ¤˜': '', 'ğŸ¤™': '',
            'ğŸ‘ˆ': '', 'ğŸ‘‰': '', 'ğŸ‘†': '', 'ğŸ‘‡': '', 'â˜ï¸': '', 'âœ‹': '', 'ğŸ¤š': '', 'ğŸ–': '',
            'ğŸ––': '', 'ğŸ‘‹': '', 'ğŸ¤': '', 'ğŸ’ª': '', 'ğŸ¦¾': '', 'ğŸ–•': '', 'âœï¸': '', 'ğŸ™': '',
            'ğŸ¦¶': '', 'ğŸ¦µ': '', 'ğŸ‘‚': '', 'ğŸ¦»': '', 'ğŸ‘ƒ': '', 'ğŸ§ ': '', 'ğŸ¦·': '', 'ğŸ¦´': '',
            'ğŸ‘€': '', 'ğŸ‘': '', 'ğŸ‘…': '', 'ğŸ‘„': '', 'ğŸ’‹': '', 'ğŸ©¸': '',
            
            # åŠ¨ç‰©å’Œè‡ªç„¶
            'ğŸ¶': '', 'ğŸ±': '', 'ğŸ­': '', 'ğŸ¹': '', 'ğŸ°': '', 'ğŸ¦Š': '', 'ğŸ»': '', 'ğŸ¼': '',
            'ğŸ¨': '', 'ğŸ¯': '', 'ğŸ¦': '', 'ğŸ®': '', 'ğŸ·': '', 'ğŸ½': '', 'ğŸ¸': '', 'ğŸµ': '',
            'ğŸ™ˆ': '', 'ğŸ™‰': '', 'ğŸ™Š': '', 'ğŸ’': '', 'ğŸ”': '', 'ğŸ§': '', 'ğŸ¦': '', 'ğŸ¤': '',
            'ğŸ£': '', 'ğŸ¥': '', 'ğŸ¦†': '', 'ğŸ¦…': '', 'ğŸ¦‰': '', 'ğŸ¦‡': '', 'ğŸº': '', 'ğŸ—': '',
            'ğŸ´': '', 'ğŸ¦„': '', 'ğŸ': '', 'ğŸ›': '', 'ğŸ¦‹': '', 'ğŸŒ': '', 'ğŸ': '', 'ğŸœ': '',
            'ğŸ¦Ÿ': '', 'ğŸ¦—': '', 'ğŸ•·': '', 'ğŸ•¸': '', 'ğŸ¦‚': '', 'ğŸ¢': '', 'ğŸ': '', 'ğŸ¦': '',
            'ğŸ¦–': '', 'ğŸ¦•': '', 'ğŸ™': '', 'ğŸ¦‘': '', 'ğŸ¦': '', 'ğŸ¦': '', 'ğŸ¦€': '', 'ğŸ¡': '',
            'ğŸ ': '', 'ğŸŸ': '', 'ğŸ¬': '', 'ğŸ³': '', 'ğŸ‹': '', 'ğŸ¦ˆ': '', 'ğŸŠ': '', 'ğŸ…': '',
            'ğŸ†': '', 'ğŸ¦“': '', 'ğŸ¦': '', 'ğŸ¦§': '', 'ğŸ˜': '', 'ğŸ¦›': '', 'ğŸ¦': '', 'ğŸª': '',
            'ğŸ«': '', 'ğŸ¦’': '', 'ğŸ¦˜': '', 'ğŸƒ': '', 'ğŸ‚': '', 'ğŸ„': '', 'ğŸ': '', 'ğŸ–': '',
            'ğŸ': '', 'ğŸ‘': '', 'ğŸ¦™': '', 'ğŸ': '', 'ğŸ¦Œ': '', 'ğŸ•': '', 'ğŸ©': '', 'ğŸ¦®': '',
            'ğŸ•â€ğŸ¦º': '', 'ğŸˆ': '', 'ğŸ“': '', 'ğŸ¦ƒ': '', 'ğŸ¦š': '', 'ğŸ¦œ': '', 'ğŸ¦¢': '', 'ğŸ¦©': '',
            'ğŸ•Š': '', 'ğŸ‡': '', 'ğŸ¦': '', 'ğŸ¦¨': '', 'ğŸ¦¡': '', 'ğŸ¦¦': '', 'ğŸ¦¥': '', 'ğŸ': '',
            'ğŸ€': '', 'ğŸ¿': '', 'ğŸ¦”': '',
            
            # é£Ÿç‰©å’Œé¥®æ–™
            'ğŸ': '', 'ğŸ': '', 'ğŸŠ': '', 'ğŸ‹': '', 'ğŸŒ': '', 'ğŸ‰': '', 'ğŸ‡': '', 'ğŸ“': '',
            'ğŸ«': '', 'ğŸˆ': '', 'ğŸ’': '', 'ğŸ‘': '', 'ğŸ¥­': '', 'ğŸ': '', 'ğŸ¥¥': '', 'ğŸ¥': '',
            'ğŸ…': '', 'ğŸ†': '', 'ğŸ¥‘': '', 'ğŸ¥¦': '', 'ğŸ¥¬': '', 'ğŸ¥’': '', 'ğŸŒ¶': '', 'ğŸ«‘': '',
            'ğŸŒ½': '', 'ğŸ¥•': '', 'ğŸ«’': '', 'ğŸ§„': '', 'ğŸ§…': '', 'ğŸ¥”': '', 'ğŸ ': '', 'ğŸ¥': '',
            'ğŸ¥¯': '', 'ğŸ': '', 'ğŸ¥–': '', 'ğŸ¥¨': '', 'ğŸ§€': '', 'ğŸ¥š': '', 'ğŸ³': '', 'ğŸ§ˆ': '',
            'ğŸ¥': '', 'ğŸ§‡': '', 'ğŸ¥“': '', 'ğŸ¥©': '', 'ğŸ—': '', 'ğŸ–': '', 'ğŸ¦´': '', 'ğŸŒ­': '',
            'ğŸ”': '', 'ğŸŸ': '', 'ğŸ•': '', 'ğŸ«“': '', 'ğŸ¥™': '', 'ğŸŒ®': '', 'ğŸŒ¯': '', 'ğŸ«”': '',
            'ğŸ¥—': '', 'ğŸ¥˜': '', 'ğŸ«•': '', 'ğŸ': '', 'ğŸœ': '', 'ğŸ²': '', 'ğŸ›': '', 'ğŸ£': '',
            'ğŸ±': '', 'ğŸ¥Ÿ': '', 'ğŸ¦ª': '', 'ğŸ¤': '', 'ğŸ™': '', 'ğŸš': '', 'ğŸ˜': '', 'ğŸ¥': '',
            'ğŸ¥ ': '', 'ğŸ¥®': '', 'ğŸ¢': '', 'ğŸ¡': '', 'ğŸ§': '', 'ğŸ¨': '', 'ğŸ¦': '', 'ğŸ¥§': '',
            'ğŸ§': '', 'ğŸ°': '', 'ğŸ‚': '', 'ğŸ®': '', 'ğŸ­': '', 'ğŸ¬': '', 'ğŸ«': '', 'ğŸ¿': '',
            'ğŸ©': '', 'ğŸª': '', 'ğŸŒ°': '', 'ğŸ¥œ': '', 'ğŸ¯': '', 'ğŸ¥›': '', 'ğŸ¼': '', 'â˜•': '',
            'ğŸµ': '', 'ğŸ§ƒ': '', 'ğŸ¥¤': '', 'ğŸ¶': '', 'ğŸº': '', 'ğŸ»': '', 'ğŸ¥‚': '', 'ğŸ·': '',
            'ğŸ¥ƒ': '', 'ğŸ¸': '', 'ğŸ¹': '', 'ğŸ§‰': '', 'ğŸ¾': '',
            
            # å…¶ä»–å¸¸è§ç¬¦å·
            'â¤ï¸': '', 'ğŸ§¡': '', 'ğŸ’›': '', 'ğŸ’š': '', 'ğŸ’™': '', 'ğŸ’œ': '', 'ğŸ–¤': '', 'ğŸ¤': '',
            'ğŸ¤': '', 'ğŸ’”': '', 'â£ï¸': '', 'ğŸ’•': '', 'ğŸ’': '', 'ğŸ’“': '', 'ğŸ’—': '', 'ğŸ’–': '',
            'ğŸ’˜': '', 'ğŸ’': '', 'ğŸ’Ÿ': '', 'â™¥ï¸': '', 'ğŸ’¯': '', 'ğŸ’¢': '', 'ğŸ’¥': '', 'ğŸ’«': '',
            'ğŸ’¦': '', 'ğŸ’¨': '', 'ğŸ•³': '', 'ğŸ’£': '', 'ğŸ’¬': '', 'ğŸ‘â€ğŸ—¨': '', 'ğŸ—¨': '', 'ğŸ—¯': '',
            'ğŸ’­': '', 'ğŸ’¤': '', 'ğŸ‘‹': '', 'ğŸ¤š': '', 'ğŸ–': '', 'âœ‹': '', 'ğŸ––': '', 'ğŸ‘Œ': '',
            'ğŸ¤Œ': '', 'ğŸ¤': '', 'âœŒï¸': '', 'ğŸ¤': '', 'ğŸ¤Ÿ': '', 'ğŸ¤˜': '', 'ğŸ¤™': '', 'ğŸ‘ˆ': '',
            'ğŸ‘‰': '', 'ğŸ‘†': '', 'ğŸ–•': '', 'ğŸ‘‡': '', 'â˜ï¸': '', 'ğŸ‘': '', 'ğŸ‘': '', 'âœŠ': '',
            'ğŸ‘Š': '', 'ğŸ¤›': '', 'ğŸ¤œ': '', 'ğŸ‘': '', 'ğŸ™Œ': '', 'ğŸ‘': '', 'ğŸ¤²': '', 'ğŸ¤': '',
            'ğŸ™': '', 'âœï¸': '', 'ğŸ’…': '', 'ğŸ¤³': '', 'ğŸ’ª': '', 'ğŸ¦¾': '', 'ğŸ¦¿': '', 'ğŸ¦µ': '',
            'ğŸ¦¶': '', 'ğŸ‘‚': '', 'ğŸ¦»': '', 'ğŸ‘ƒ': '', 'ğŸ§ ': '', 'ğŸ«€': '', 'ğŸ«': '', 'ğŸ¦·': '',
            'ğŸ¦´': '', 'ğŸ‘€': '', 'ğŸ‘': '', 'ğŸ‘…': '', 'ğŸ‘„': '', 'ğŸ’‹': '', 'ğŸ©¸': '',
            
            # ç®­å¤´å’Œç¬¦å·
            'â†’': ' ', 'â†': ' ', 'â†‘': ' ', 'â†“': ' ', 'â†”': ' ', 'â†•': ' ', 'â†–': ' ', 'â†—': ' ',
            'â†˜': ' ', 'â†™': ' ', 'â¤´': ' ', 'â¤µ': ' ', 'ğŸ”ƒ': ' ', 'ğŸ”„': ' ', 'ğŸ”™': ' ', 'ğŸ”š': ' ',
            'ğŸ”›': ' ', 'ğŸ”œ': ' ', 'ğŸ”': ' ',
            
            # æ•°å­¦å’Œç‰¹æ®Šç¬¦å·
            'Â±': 'æ­£è´Ÿ', 'Ã—': 'ä¹˜ä»¥', 'Ã·': 'é™¤ä»¥', '=': 'ç­‰äº', 'â‰ ': 'ä¸ç­‰äº', 'â‰ˆ': 'çº¦ç­‰äº',
            'â‰¤': 'å°äºç­‰äº', 'â‰¥': 'å¤§äºç­‰äº', '<': 'å°äº', '>': 'å¤§äº', 'âˆ': 'æ— ç©·å¤§',
            'âˆ‘': 'æ±‚å’Œ', 'âˆ': 'è¿ä¹˜', 'âˆ«': 'ç§¯åˆ†', 'âˆ‚': 'åå¾®åˆ†', 'âˆ†': 'å¢é‡',
            'âˆš': 'æ ¹å·', 'âˆ›': 'ç«‹æ–¹æ ¹', 'âˆœ': 'å››æ¬¡æ–¹æ ¹', 'Â²': 'å¹³æ–¹', 'Â³': 'ç«‹æ–¹',
            'Â°': 'åº¦', '%': 'ç™¾åˆ†ä¹‹', 'â€°': 'åƒåˆ†ä¹‹', 'â€±': 'ä¸‡åˆ†ä¹‹',
            
            # è´§å¸ç¬¦å·
            '$': 'ç¾å…ƒ', 'â‚¬': 'æ¬§å…ƒ', 'Â£': 'è‹±é•‘', 'Â¥': 'äººæ°‘å¸', 'â‚¹': 'å¢æ¯”',
            'â‚½': 'å¢å¸ƒ', 'â‚©': 'éŸ©å…ƒ', 'â‚ª': 'è°¢å…‹å°”', 'â‚«': 'è¶Šå—ç›¾',
            
            # æ ‡ç‚¹ç¬¦å·ä¼˜åŒ–ï¼ˆä¿ç•™ä¸­æ–‡æ ‡ç‚¹ç¬¦å·ï¼‰
            'â€¦': '...', 'â€”': '-', 'â€“': '-', ''': "'", ''': "'", '"': '"', '"': '"',
            'Â«': '"', 'Â»': '"', 'â€¹': "'", 'â€º': "'", 'â€': '"', 'â€š': "'",
            # æ³¨æ„ï¼šä¸è¦æ›¿æ¢ä¸­æ–‡æ ‡ç‚¹ç¬¦å· ï¼Œã€‚ï¼ï¼Ÿï¼›ï¼š
            
            # å…¶ä»–ç¬¦å·
            'Â©': 'ç‰ˆæƒ', 'Â®': 'æ³¨å†Œå•†æ ‡', 'â„¢': 'å•†æ ‡', 'Â§': 'ç« èŠ‚', 'Â¶': 'æ®µè½',
            'â€ ': '', 'â€¡': '', 'â€¢': '', 'â€°': 'åƒåˆ†ä¹‹', 'â€²': 'åˆ†', 'â€³': 'ç§’',
            'â€´': '', 'â€»': '', 'â€¼': '!!', 'â‡': '??', 'âˆ': '?!', 'â‰': '!?',
            'â°': '0', 'Â¹': '1', 'Â²': '2', 'Â³': '3', 'â´': '4', 'âµ': '5',
            'â¶': '6', 'â·': '7', 'â¸': '8', 'â¹': '9',
            'â‚€': '0', 'â‚': '1', 'â‚‚': '2', 'â‚ƒ': '3', 'â‚„': '4', 'â‚…': '5',
            'â‚†': '6', 'â‚‡': '7', 'â‚ˆ': '8', 'â‚‰': '9',
            
            # ç‰¹æ®Šç©ºæ ¼å’Œåˆ†éš”ç¬¦
            '\u00A0': ' ',  # ä¸é—´æ–­ç©ºæ ¼
            '\u2000': ' ',  # en quad
            '\u2001': ' ',  # em quad
            '\u2002': ' ',  # en space
            '\u2003': ' ',  # em space
            '\u2004': ' ',  # three-per-em space
            '\u2005': ' ',  # four-per-em space
            '\u2006': ' ',  # six-per-em space
            '\u2007': ' ',  # figure space
            '\u2008': ' ',  # punctuation space
            '\u2009': ' ',  # thin space
            '\u200A': ' ',  # hair space
            '\u200B': '',   # zero width space
            '\u200C': '',   # zero width non-joiner
            '\u200D': '',   # zero width joiner
            '\u2060': '',   # word joiner
            '\uFEFF': '',   # zero width no-break space
        }
        
        # ç½‘å€å’Œé‚®ç®±æ­£åˆ™
        self.url_pattern = re.compile(
            r'http[s]?://(?:[a-zA-Z]|[0-9]|[$-_@.&+]|[!*\\(\\),]|(?:%[0-9a-fA-F][0-9a-fA-F]))+'
        )
        self.email_pattern = re.compile(r'\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b')
        
        # ä»£ç å—æ­£åˆ™ï¼ˆä¿®å¤å¤šè¡ŒåŒ¹é…ï¼‰
        self.code_block_pattern = re.compile(r'```[\s\S]*?```', re.DOTALL)
        self.inline_code_pattern = re.compile(r'`[^`\n]+`')
        
        # Markdowné“¾æ¥æ­£åˆ™
        self.markdown_link_pattern = re.compile(r'\[([^\]]+)\]\([^\)]+\)')
        
        logging.info("æ–‡æœ¬æ¸…ç†å™¨åˆå§‹åŒ–å®Œæˆ")
    
    def clean_for_tts(self, text: str) -> str:
        """æ¸…ç†æ–‡æœ¬ç”¨äºTTSæœ—è¯»"""
        if not text:
            return ""

        try:
            original_text = text

            # 1. ç§»é™¤ä»£ç å—
            text = self.code_block_pattern.sub('', text)
            text = self.inline_code_pattern.sub('', text)

            # 2. å¤„ç†Markdowné“¾æ¥ï¼Œä¿ç•™é“¾æ¥æ–‡æœ¬
            text = self.markdown_link_pattern.sub(r'\1', text)

            # 3. ç§»é™¤ç½‘å€
            text = self.url_pattern.sub('', text)

            # 4. ç§»é™¤é‚®ç®±
            text = self.email_pattern.sub('', text)

            # 5. ç§»é™¤è¡¨æƒ…ç¬¦å·ï¼ˆä½¿ç”¨æ›´ç›´æ¥çš„æ–¹æ³•ï¼‰
            # å…ˆç”¨æ­£åˆ™è¡¨è¾¾å¼
            text = self.emoji_pattern.sub('', text)

            # ç„¶åç”¨å­—ç¬¦æ›¿æ¢ï¼ˆç¡®ä¿æ¸…ç†å¸¸è§è¡¨æƒ…ç¬¦å·å’Œè£…é¥°ç¬¦å·ï¼‰
            # è¡¨æƒ…ç¬¦å·
            emoji_chars = 'ğŸ˜€ğŸ˜ğŸ˜‚ğŸ¤£ğŸ˜ƒğŸ˜„ğŸ˜…ğŸ˜†ğŸ˜‰ğŸ˜ŠğŸ˜‹ğŸ˜ğŸ˜ğŸ˜˜ğŸ¥°ğŸ˜—ğŸ˜™ğŸ˜šâ˜ºï¸ğŸ™‚ğŸ¤—ğŸ¤©ğŸ¤”ğŸ¤¨ğŸ˜ğŸ˜‘ğŸ˜¶ğŸ™„ğŸ˜ğŸ˜£ğŸ˜¥ğŸ˜®ğŸ¤ğŸ˜¯ğŸ˜ªğŸ˜«ğŸ˜´ğŸ˜ŒğŸ˜›ğŸ˜œğŸ˜ğŸ¤¤ğŸ˜’ğŸ˜“ğŸ˜”ğŸ˜•ğŸ™ƒğŸ¤‘ğŸ˜²â˜¹ï¸ğŸ™ğŸ˜–ğŸ˜ğŸ˜ŸğŸ˜¤ğŸ˜¢ğŸ˜­ğŸ˜¦ğŸ˜§ğŸ˜¨ğŸ˜©ğŸ¤¯ğŸ˜¬ğŸ˜°ğŸ˜±ğŸ¥µğŸ¥¶ğŸ˜³ğŸ¤ªğŸ˜µğŸ˜¡ğŸ˜ ğŸ¤¬ğŸ˜·ğŸ¤’ğŸ¤•ğŸ¤¢ğŸ¤®ğŸ¤§ğŸ˜‡ğŸ¥³ğŸ¥ºğŸ¤ ğŸ¤¡ğŸ¤¥ğŸ¤«ğŸ¤­ğŸ§ğŸ‘ğŸ‘ğŸ‘ŒâœŒï¸ğŸ¤ğŸ¤ŸğŸ¤˜ğŸ¤™ğŸ‘ˆğŸ‘‰ğŸ‘†ğŸ‘‡â˜ï¸âœ‹ğŸ¤šğŸ–ğŸ––ğŸ‘‹ğŸ¤ğŸ’ªğŸ¦¾ğŸ–•âœï¸ğŸ™ğŸ‰ğŸ’°â¤ï¸ğŸ’¯ğŸ”¥ğŸ’•ğŸ’–ğŸ’—ğŸ’˜ğŸ’ğŸ’ğŸ’ŸğŸ’¢ğŸ’¤ğŸ’¥ğŸ’¦ğŸ’¨ğŸ’«ğŸ’¬ğŸ’­ğŸ—¯ğŸ’®'
            for char in emoji_chars:
                text = text.replace(char, '')

            # è£…é¥°æ€§ç¬¦å·å’Œç‰¹æ®Šå­—ç¬¦
            decorative_chars = 'ğŸŒŸğŸŒ¸âœ¨ï½â­ğŸ’«âš¡ğŸŒˆğŸˆğŸŠğŸğŸ€ğŸŒºğŸŒ»ğŸŒ·ğŸŒ¹ğŸŒ¼ğŸŒ™â˜€ï¸â›…ğŸŒ¤ï¸ğŸŒ¦ï¸ğŸŒ§ï¸â›ˆï¸ğŸŒ©ï¸ğŸŒ¨ï¸â„ï¸â˜ƒï¸â›„ğŸŒ¬ï¸ğŸ’¨ğŸŒªï¸ğŸŒ«ï¸ğŸŒŠğŸ’§ğŸ’¦â˜”âš¡ğŸ”¥ğŸ’¥âœ¨â­ğŸŒŸğŸ’«â­ğŸŒ ğŸŒŒğŸŒƒğŸŒ†ğŸŒ‡ğŸŒ‰ğŸŒğŸ”ï¸â›°ï¸ğŸŒ‹ğŸ—»ğŸ•ï¸ğŸ–ï¸ğŸœï¸ğŸï¸ğŸï¸ğŸŸï¸ğŸ›ï¸ğŸ—ï¸ğŸ˜ï¸ğŸšï¸ğŸ ğŸ¡ğŸ¢ğŸ£ğŸ¤ğŸ¥ğŸ¦ğŸ§ğŸ¨ğŸ©ğŸªğŸ«ğŸ¬ğŸ­ğŸ¯ğŸ°ğŸ—¼ğŸ—½â›ªğŸ•ŒğŸ›•ğŸ•â›©ï¸ğŸ•‹â›²â›ºğŸŒğŸŒ‹ğŸ—»ğŸ”ï¸â›°ï¸ğŸŒ„ğŸŒ…ğŸŒ†ğŸŒ‡ğŸŒ‰â™¨ï¸ğŸ ğŸ¡ğŸ¢ğŸ’ˆğŸªğŸš‚ğŸšƒğŸš„ğŸš…ğŸš†ğŸš‡ğŸšˆğŸš‰ğŸšŠğŸšğŸšğŸš‹ğŸšŒğŸšğŸšğŸšğŸš‘ğŸš’ğŸš“ğŸš”ğŸš•ğŸš–ğŸš—ğŸš˜ğŸš™ğŸššğŸš›ğŸšœğŸï¸ğŸï¸ğŸ›µğŸš²ğŸ›´ğŸ›¹ğŸ›¼ğŸšğŸ›¸ğŸš€âœˆï¸ğŸ›©ï¸ğŸ›«ğŸ›¬ğŸª‚ğŸ’ºğŸš¢â›µğŸš¤ğŸ›¥ï¸ğŸ›³ï¸â›´ï¸ğŸš§âš“â›½ğŸš¨ğŸš¥ğŸš¦ğŸ›‘ğŸšâš“â›µğŸš¤ğŸ›¥ï¸ğŸ›³ï¸â›´ï¸ğŸš¢ğŸš§âš“â›½ğŸš¨ğŸš¥ğŸš¦ğŸ›‘ğŸš'
            for char in decorative_chars:
                text = text.replace(char, '')

            # ç‰¹æ®Šç¬¦å·å’Œæ³¢æµªçº¿ç­‰
            special_symbols = 'ï½ã€œâˆ¼â‰ˆâ‰‹â‰…â‰ƒâ‰‚â‰¡â‰¢â‰£â‰¤â‰¥â‰¦â‰§â‰¨â‰©â‰ªâ‰«â‰¬â‰­â‰®â‰¯â‰°â‰±â‰²â‰³â‰´â‰µâ‰¶â‰·â‰¸â‰¹â‰ºâ‰»â‰¼â‰½â‰¾â‰¿âŠ€âŠâŠ‚âŠƒâŠ„âŠ…âŠ†âŠ‡âŠˆâŠ‰âŠŠâŠ‹âŠŒâŠâŠâŠâŠâŠ‘âŠ’âŠ“âŠ”âŠ•âŠ–âŠ—âŠ˜âŠ™âŠšâŠ›âŠœâŠâŠâŠŸâŠ âŠ¡âŠ¢âŠ£âŠ¤âŠ¥âŠ¦âŠ§âŠ¨âŠ©âŠªâŠ«âŠ¬âŠ­âŠ®âŠ¯âŠ°âŠ±âŠ²âŠ³âŠ´âŠµâŠ¶âŠ·âŠ¸âŠ¹âŠºâŠ»âŠ¼âŠ½âŠ¾âŠ¿â‹€â‹â‹‚â‹ƒâ‹„â‹…â‹†â‹‡â‹ˆâ‹‰â‹Šâ‹‹â‹Œâ‹â‹â‹â‹â‹‘â‹’â‹“â‹”â‹•â‹–â‹—â‹˜â‹™â‹šâ‹›â‹œâ‹â‹â‹Ÿâ‹ â‹¡â‹¢â‹£â‹¤â‹¥â‹¦â‹§â‹¨â‹©â‹ªâ‹«â‹¬â‹­â‹®â‹¯â‹°â‹±â‹²â‹³â‹´â‹µâ‹¶â‹·â‹¸â‹¹â‹ºâ‹»â‹¼â‹½â‹¾â‹¿'
            for char in special_symbols:
                text = text.replace(char, '')

            # ç®­å¤´ç¬¦å·
            arrow_symbols = 'â†â†‘â†’â†“â†”â†•â†–â†—â†˜â†™â†šâ†›â†œâ†â†â†Ÿâ† â†¡â†¢â†£â†¤â†¥â†¦â†§â†¨â†©â†ªâ†«â†¬â†­â†®â†¯â†°â†±â†²â†³â†´â†µâ†¶â†·â†¸â†¹â†ºâ†»â†¼â†½â†¾â†¿â‡€â‡â‡‚â‡ƒâ‡„â‡…â‡†â‡‡â‡ˆâ‡‰â‡Šâ‡‹â‡Œâ‡â‡â‡â‡â‡‘â‡’â‡“â‡”â‡•â‡–â‡—â‡˜â‡™â‡šâ‡›â‡œâ‡â‡â‡Ÿâ‡ â‡¡â‡¢â‡£â‡¤â‡¥â‡¦â‡§â‡¨â‡©â‡ªâ‡«â‡¬â‡­â‡®â‡¯â‡°â‡±â‡²â‡³â‡´â‡µâ‡¶â‡·â‡¸â‡¹â‡ºâ‡»â‡¼â‡½â‡¾â‡¿'
            for char in arrow_symbols:
                text = text.replace(char, '')

            # æ˜Ÿå·å’Œç‚¹çŠ¶ç¬¦å·
            star_symbols = 'â˜…â˜†âœ¦âœ§âœ©âœªâœ«âœ¬âœ­âœ®âœ¯âœ°âœ±âœ²âœ³âœ´âœµâœ¶âœ·âœ¸âœ¹âœºâœ»âœ¼âœ½âœ¾âœ¿â€ââ‚âƒâ„â…â†â‡âˆâ‰âŠâ‹âŒâââââ‘â’â“â”â•â–â—â˜â™âšâ›âœâââŸâ â¡â¢â£â¤â¥â¦â§â¨â©âªâ«â¬â­â®â¯â°â±â²â³â´âµâ¶â·â¸â¹âºâ»â¼â½â¾â¿â€ââ‚âƒâ„â…â†â‡âˆâ‰âŠâ‹âŒâââââ‘â’â“â”â•â–â—â˜â™âšâ›âœâââŸâ â¡â¢â£â¤â¥â¦â§â¨â©âªâ«â¬â­â®â¯â°â±â²â³â´âµâ¶â·â¸â¹âºâ»â¼â½â¾â¿'
            for char in star_symbols:
                text = text.replace(char, '')

            # 6. åªæ›¿æ¢ç¡®å®éœ€è¦æ›¿æ¢çš„ç‰¹æ®Šç¬¦å·
            # è´§å¸ç¬¦å·
            currency_symbols = ['$', 'â‚¬', 'Â£', 'Â¥', 'â‚¹', 'â‚½', 'â‚©', 'â‚ª', 'â‚«']
            for symbol in currency_symbols:
                if symbol in text:
                    text = text.replace(symbol, self.special_symbols.get(symbol, ''))

            # æ•°å­¦ç¬¦å·
            math_symbols = ['Â±', 'Ã—', 'Ã·', 'â‰ ', 'â‰ˆ', 'â‰¤', 'â‰¥', 'âˆ', 'âˆ‘', 'âˆ', 'âˆ«', 'âˆ‚', 'âˆ†', 'âˆš', 'âˆ›', 'âˆœ']
            for symbol in math_symbols:
                if symbol in text:
                    text = text.replace(symbol, self.special_symbols.get(symbol, ''))



            # 7. æ¸…ç†å¤šä½™çš„ç©ºæ ¼
            text = re.sub(r'\s+', ' ', text)
            text = text.strip()

            # 8. å¦‚æœæ¸…ç†åæ–‡æœ¬ä¸ºç©ºæˆ–è¿‡çŸ­ï¼Œè¿”å›åŸæ–‡æœ¬ï¼ˆå¯èƒ½æ˜¯æ­£å¸¸æ–‡æœ¬ï¼‰
            if not text.strip() or len(text.strip()) < 3:
                # æ£€æŸ¥åŸæ–‡æœ¬æ˜¯å¦ä¸»è¦æ˜¯ä¸­æ–‡æˆ–è‹±æ–‡
                if re.search(r'[\u4e00-\u9fff\w]', original_text):
                    return original_text.strip()

            return text

        except Exception as e:
            logging.error(f"æ–‡æœ¬æ¸…ç†å¤±è´¥: {e}")
            return text
    
    def clean_for_display(self, text: str) -> str:
        """æ¸…ç†æ–‡æœ¬ç”¨äºæ˜¾ç¤ºï¼ˆä¿ç•™æ›´å¤šæ ¼å¼ï¼‰"""
        if not text:
            return ""
        
        try:
            # åªè¿›è¡ŒåŸºæœ¬æ¸…ç†ï¼Œä¿ç•™å¤§éƒ¨åˆ†æ ¼å¼
            # ç§»é™¤é›¶å®½å­—ç¬¦
            for char in ['\u200B', '\u200C', '\u200D', '\u2060', '\uFEFF']:
                text = text.replace(char, '')
            
            # æ ‡å‡†åŒ–ç©ºæ ¼
            text = re.sub(r'[\u00A0\u2000-\u200A]', ' ', text)
            
            # æ¸…ç†å¤šä½™çš„ç©ºæ ¼
            text = re.sub(r' +', ' ', text)
            text = text.strip()
            
            return text
            
        except Exception as e:
            logging.error(f"æ˜¾ç¤ºæ–‡æœ¬æ¸…ç†å¤±è´¥: {e}")
            return text
    
    def extract_readable_text(self, text: str) -> str:
        """æå–å¯è¯»æ–‡æœ¬ï¼ˆç”¨äºè¯­éŸ³è¯†åˆ«ç»“æœå¤„ç†ï¼‰"""
        if not text:
            return ""
        
        try:
            # ç§»é™¤è¡¨æƒ…ç¬¦å·
            text = self.emoji_pattern.sub('', text)
            
            # åŸºæœ¬ç¬¦å·æ›¿æ¢
            basic_replacements = {
                '&': 'å’Œ',
                '@': 'åœ¨',
                '#': 'äº•å·',
                '*': 'æ˜Ÿå·',
                '+': 'åŠ ',
                '-': 'å‡',
                '/': 'æ–œæ ',
                '\\': 'åæ–œæ ',
                '|': 'ç«–çº¿',
                '~': 'æ³¢æµªå·',
                '^': 'ä¸Šæ ‡',
                '_': 'ä¸‹åˆ’çº¿',
                '=': 'ç­‰å·',
                '[': 'å·¦æ–¹æ‹¬å·',
                ']': 'å³æ–¹æ‹¬å·',
                '{': 'å·¦å¤§æ‹¬å·',
                '}': 'å³å¤§æ‹¬å·',
                '(': 'å·¦æ‹¬å·',
                ')': 'å³æ‹¬å·',
                '<': 'å°äº',
                '>': 'å¤§äº',
            }
            
            for symbol, replacement in basic_replacements.items():
                text = text.replace(symbol, replacement)
            
            # æ¸…ç†ç©ºæ ¼
            text = re.sub(r'\s+', ' ', text)
            text = text.strip()
            
            return text
            
        except Exception as e:
            logging.error(f"æå–å¯è¯»æ–‡æœ¬å¤±è´¥: {e}")
            return text

# å…¨å±€æ–‡æœ¬æ¸…ç†å™¨å®ä¾‹
text_cleaner = TextCleaner()

def get_text_cleaner() -> TextCleaner:
    """è·å–æ–‡æœ¬æ¸…ç†å™¨å®ä¾‹"""
    return text_cleaner

def clean_text_for_tts(text: str) -> str:
    """å¿«é€Ÿæ¸…ç†æ–‡æœ¬ç”¨äºTTS"""
    return text_cleaner.clean_for_tts(text)

def clean_text_for_display(text: str) -> str:
    """å¿«é€Ÿæ¸…ç†æ–‡æœ¬ç”¨äºæ˜¾ç¤º"""
    return text_cleaner.clean_for_display(text)
